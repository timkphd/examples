alias git-home='git remote show origin'

account() {
    if (( $# > 0 )) ; then
      sacctmgr show assoc user=$1 format=account
      lslogins $1
    else
      sacctmgr show assoc user=tkaiser2 format=account
    fi
}

scr() {
    if [ $# -lt 1 ]; then 
    cd /scratch/$USER
    else
    cd /scratch/$USER/$1
    fi
    }

today() {     
     local now=`date +"%Y-%m-%d"`
     if (( $# > 0 )) ; then   
         if [[ $1 == "-f" ]] ; then 
            find . -type f -newermt $now
         fi
         if [[ $1 == "-d" ]] ; then 
            find . -type d -newermt $now
         fi
    else
        find .  -newermt $now
    fi
    }


cstrip() {
# You can effectively make comments in a
# bash script by delimiting with :<<++++ and ++++
# This function removes them.
for script in "$@" ; do
    out=_$script
    echo $out
    sed  '/:<<++++/,/^++++/d' $script > $out
done
}

dogpu() until sq | grep $1 > /dev/null ; (($?)) ;do date ; gpus ; sleep 5; done
docpu() until sq | grep $1 > /dev/null ; (($?)) ;do date ; onnodes  ; sleep 5; done



running() { nl=`sq | wc -l`; if [ "$nl" -gt "1" ] ; then return 0 ; else return 1 ; fi; }

dorunning() { running ; while [ $? -eq "0" ] ; do echo "running" ; sleep 10 ; running ; done }

setperm() {
    echo setting permissions for $1
    find $1 -perm -u=x -exec chmod go+x {} \; 
    find $1 -perm -u=r -exec chmod go+r {} \; 
}

mdiff(){ d1=$1 ;  while test $# -gt 0; do     ls -lt $1 ; diff $d1 $1;     echo ++++++++++++++++++++++++++++++ ;shift; done;  }


tunnel() {
# Bash function to set up a ssh tunnel to connect to a jupyter 
# notebook running on Eagle or a compute node.
# 
# To use this add it in your .bashrc file on your DESKTOP MACHINE
# NOT EAGLE  or save it to dotunnel and do a source dotunnel. 
#
# Takes two arguments, the node running our notebook and port number
# from the http string returned by jupyter.
# 
# Note: the -t option for the ssh command allows an interactive 
# session on the node to which we are connecting.
#
# Check for the correct number of arguments.
    if [ $# -lt 2 ]; then 
        echo "Usage:"
        echo "tunnel NODE_NAME PORT"
        echo "tunnel -help"
        if [[ $1 = -h* ]] ; then
          echo "where NODE_NAME is the node on which you are running."
		  echo "PORT is the number, usually 8888 returned by jupyter."
		  echo "After running this function copy the http://... string "
		  echo "returned by jupyter to your local browser. "
		  echo " "
		  echo "If you get a message of the form:"
		  echo "bind [127.0.0.1]:8888: Address already in use"
		  echo "You can close the port."
		  echo "Run the following command on your linux/Mac :"
		  echo "lsof -i TCP:8888 | grep ssh | awk '{print $2}' | head -1"
		  echo "This will give the process id using the port, say 12768."
		  echo "Then run the kill command on the process, for example:"
		  echo "     kill 12768"
		  echo "If you don't want to close the port you can run this command"
		  echo "and specify a new local port, say 8889"
		  echo "     tunnel el1 8888 8895"
		  echo "Then when you copy the string from jupyter replace 8888 with 8895."
		fi
        return -1
    fi
# Check that the second argument in an integer
    echo "$2" | grep -E ^\-?[0-9]+$ > /dev/null
    if [ $? -ne 0 ]  ; then 
        echo "Usage:"
        echo "tunnel NODE_NAME PORT"
        echo "tunnel -help"
        return -1
	fi
	port=$2
	node=$1
	lport=$port
	if [ $# -eq 3 ]; then
	    lport=$3
	fi   
case $node in
  e*)
 	# If we are running on an Eagle login node (starts with e) then use the 
	# short form of the tunnel, no hop. 
			echo "Running:"
			echo ssh -t -L $lport:localhost:$port $node.hpc.nrel.gov
				 ssh -t -L $lport:localhost:$port $node.hpc.nrel.gov
    ;;
  s*)
 	# If we are running on a swift login node (starts with s) then use the 
	# short form of the tunnel, no hop. 
			echo "Running:"
			echo ssh -t -L $lport:localhost:$port $node.hpc.nrel.gov
				 ssh -t -L $lport:localhost:$port $node.hpc.nrel.gov
    ;;
  vs-login*)
 	# If we are running on a vermilion login node (starts with vs-login) then use the 
	# short form of the tunnel, no hop.
			echo "Running:"
			echo ssh -t -L $lport:localhost:$port $node.hpc.nrel.gov
				 ssh -t -L $lport:localhost:$port $node.hpc.nrel.gov
    ;;
  1*)
 	# Giving an address that starts with a 1, most likely a machine
 	# on your local network.  Use the short form of the tunnel, no hop. 
 			echo "Running:"
			echo ssh -t -L $lport:localhost:$port $node
				 ssh -t -L $lport:localhost:$port $node
    ;;
  r*)
	# If we are running on an Eagle compute node (does not start with e) then use the 
	# long form of the tunnel. We pick a random intermediate port for the tunnel.
 			echo "Running:"
 			addto=$(( $RANDOM % 1000 ))
 			p=$(( 8100 + $addto))
			echo ssh -t -L $lport:localhost:$p eagle ssh -L $p:localhost:$port $node
				 ssh -t -L $lport:localhost:$p eagle ssh -L $p:localhost:$port $node
    ;;
  c*)
	# If we are running on a swift compute node then use the 
	# long form of the tunnel. We pick a random intermediate port for the tunnel.
 			echo "Running:"
 			addto=$(( $RANDOM % 1000 ))
 			p=$(( 8100 + $addto))
			echo ssh -t -L $lport:localhost:$p swift-login-1  ssh -L $p:localhost:$port $node
				 ssh -t -L $lport:localhost:$p swift-login-1 ssh -L $p:localhost:$port $node
    ;;
  v*)
	# If we are running on a vermilion compute node  then use the 
	# long form of the tunnel. We pick a random intermediate port for the tunnel.
 			echo "Running:"
 			addto=$(( $RANDOM % 1000 ))
 			p=$(( 8100 + $addto))
			echo ssh -t -L $lport:localhost:$p vs-login-1  ssh -L $p:localhost:$port $node
				 ssh -t -L $lport:localhost:$p vs-login-1 ssh -L $p:localhost:$port $node
    ;;
   pie)
	# Running on home cluster head node 
            echo  "Running on home cluster head node" 
 			echo ssh -t -L $lport:localhost:$port $node
				 ssh -t -L $lport:localhost:$port $node
    ;;
   pi0)
	# Running on home cluster compute node
	# long form of the tunnel. We pick a random intermediate port for the tunnel.
 			echo "Running on home cluster compute node:"
 			addto=$(( $RANDOM % 1000 ))
 			p=$(( 8100 + $addto))
			echo ssh -t -L $lport:localhost:$p pie  ssh -L $p:localhost:$port $node
				 ssh -t -L $lport:localhost:$p pie ssh -L $p:localhost:$port $node
    ;;
   *)
            echo  "unknow host node - trying no hop" 
 			echo ssh -t -L $lport:localhost:$port $node
				 ssh -t -L $lport:localhost:$port $node
    ;;
esac
	}
