bootstrap: docker
from: rockylinux:9.3.20231119
#from: rockylinux

%files
/nopt/xalt/current/lib64 /nopt/xalt/current/lib64

%post
    echo "Installing packages into the Rocky Linux 9.3 container"
    dnf -y update
    dnf install -y which
    dnf -y install epel-release
    dnf -y install apptainer-suid
    dnf -y group install "Development Tools" || echo nope Development Tools
    dnf -y upgrade --refresh
    dnf -y install openssh-server || echo nope openssh-server 
    dnf -y install openssh || echo nope openssh
    dnf -y install git
    dnf -y install cmake
    dnf -y install make
    dnf -y install wget
    dnf -y install findutils
    dnf -y install gfortran
    dnf -y update python
    dnf -y install zlib-ng || echo nope  zlib-ng 
    dnf -y install procps 
    dnf -y install perl
    dnf -y install sed

mkdir -p /extra01
mkdir -p /extra02
mkdir -p /extra03
mkdir -p /extra04
mkdir -p /build
cd /build
export STARTDIR=`pwd`
git clone https://github.com/spack/spack.git
cd spack
export SPACK_ROOT=`pwd`
export SPACK_ROOT=/build/install
export SPACK_USER_CONFIG_PATH=${SPACK_ROOT}/.spack
export SPACK_USER_CACHE_PATH=${SPACK_ROOT}/.cache
export TMPDIR=$SPACK_ROOT/tmp
mkdir -p $TMPDIR
. share/spack/setup-env.sh

spack config add "modules:default:enable:[tcl]"
spack config add "modules:default:roots:tcl:'/build/modules'"   
spack config add "config:install_tree:root:'/build/install'"   
spack config add "packages:all:target:[x86_64]"   

spack install -j 48 libxml2@2.12.9 
spack install -j 48 pkg-config
spack load pkg-config
echo "+++++++++++++++" `date`
spack install -j 48 lmod             || echo lmod nope
echo "+++++++++++++++" `date`
spack install -j 48 apptainer || echo apptainer nope
echo "+++++++++++++++" `date`
spack install -j 48 apptainer@1.3.3 +suid  || echo 1.3.3 nope
echo "+++++++++++++++" `date`
spack install -j 48 apptainer@1.1.9 +suid || echo 1.1.9 nope
echo "+++++++++++++++" `date`

for doit in `find /build/install/ -name spack_perms_fix.sh` ; do
. $doit
done

echo ". `find /build/install/* -name  bash | grep init`"  > /.singularity.d/env/99-zmine.sh            || echo find nope
echo export MODULEPATH=/build/modules/`ls /build/modules/` >>  /.singularity.d/env/99-zmine.sh      || echo modpath nope
echo export LD_LIBRARY_PATH=/nopt/xalt/current/lib64:\$LD_LIBRARY_PATH >>  /.singularity.d/env/99-zmine.sh || echo LD_LIBRARY_PATH
echo ml apptainer/1.1.9 >> /.singularity.d/env/99-zmine.sh

