bootstrap: localimage   
from:  r0.sif
#Based on https://apptainer.org/docs/user/main/mpi.html

# optionally install apptainer from source
# you will  want to install lmod also
#%files
#script /nopt/scripts/script

%environment
    # Point to MPICH binaries, libraries man pages
    export MPICH_DIR=/opt/mpich
    export PATH="$MPICH_DIR/bin:$PATH"
    export LD_LIBRARY_PATH="$MPICH_DIR/lib:$LD_LIBRARY_PATH"
    export MANPATH=$MPICH_DIR/share/man:$MANPATH
%post
dnf -y install nano which vim

    echo "Installing required packages..."
   dnf install -y wget git bash gcc  make 

    # Information about the version of MPICH to use
    export MPICH_VERSION=4.1.1
    export MPICH_URL="http://www.mpich.org/static/downloads/$MPICH_VERSION/mpich-$MPICH_VERSION.tar.gz"
    export MPICH_DIR=/opt/mpich

    echo "Installing MPICH..."
    mkdir -p /tmp/mpich
    mkdir -p /opt
    # Download
    cd /tmp/mpich && wget -O mpich-$MPICH_VERSION.tar.gz $MPICH_URL && tar xzf  mpich-$MPICH_VERSION.tar.gz --no-same-owner
    # Compile and install
    cd /tmp/mpich/mpich-$MPICH_VERSION && ./configure --prefix=$MPICH_DIR && make -j$(nproc) install

    # Set env variables so we can compile our application
    export PATH=$MPICH_DIR/bin:$PATH
    export LD_LIBRARY_PATH=$MPICH_DIR/lib:$LD_LIBRARY_PATH

echo "Compiling the MPI application..."
mkdir -p /nopt
cd /nopt && git clone https://github.com/timkphd/examples.git
mkdir /nopt/exec
cd /nopt/examples/mpi && mpif90 hellof.f90 -o /nopt/exec/hellof
cd /nopt/examples/mpi && mpicc  helloc.c -o /nopt/exec/helloc

echo  PATH=/nopt/exec\:$PATH >> /.singularity.d/env/99-zmine.sh

